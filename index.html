<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OdeÄet vodomÄ›ru</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: white;
      font-size: 2.5rem;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .input-group input:read-only {
      background-color: #f5f5f5;
      cursor: not-allowed;
    }
    
    .result {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .result-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .result-box .label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .result-box .value {
      font-size: 2rem;
      font-weight: bold;
    }
    
    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      flex: 1;
      min-width: 150px;
      padding: 15px 25px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      color: white;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-save {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    }
    
    .btn-load {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    }
    
    .btn-new {
      background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-box {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid #667eea;
    }
    
    .stat-box .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-box .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: #667eea;
      color: white;
      font-weight: 600;
    }
    
    tr:hover {
      background: #f5f5f5;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #2196f3;
    }
    
    .alert.success {
      background: #e8f5e9;
      color: #388e3c;
      border-left: 4px solid #4caf50;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .input-grid {
        grid-template-columns: 1fr;
      }
      
      .buttons {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’§ OdeÄet vodomÄ›ru</h1>
    
    <div id="alert" class="alert"></div>
    
    <div class="card">
      <h2>ğŸ“ NovÃ½ odeÄet</h2>
      <div class="input-grid">
        <div class="input-group">
          <label for="reference">ReferenÄnÃ­ stav (mÂ³)</label>
          <input type="number" id="reference" placeholder="NaÄte se automaticky" readonly>
        </div>
        <div class="input-group">
          <label for="stav">AktuÃ¡lnÃ­ stav (mÂ³)</label>
          <input type="number" id="stav" placeholder="Zadejte aktuÃ¡lnÃ­ stav" required>
        </div>
        <div class="input-group">
          <label for="datum">Datum</label>
          <input type="date" id="datum" required>
        </div>
      </div>
      
      <div class="input-grid">
        <div class="input-group">
          <label for="vodne">VodnÃ© (KÄ/mÂ³)</label>
          <input type="number" id="vodne" value="50" required>
        </div>
        <div class="input-group">
          <label for="stocne">StoÄnÃ© (KÄ/mÂ³)</label>
          <input type="number" id="stocne" value="59" required>
        </div>
        <div class="input-group">
          <label for="dph">DPH (%)</label>
          <input type="number" id="dph" value="12" required>
        </div>
      </div>
      
      <div class="result">
        <div class="result-box">
          <div class="label">SpotÅ™eba</div>
          <div class="value"><span id="spotreba">0</span> mÂ³</div>
        </div>
        <div class="result-box">
          <div class="label">Cena</div>
          <div class="value"><span id="cena">0</span> KÄ</div>
        </div>
      </div>
      
      <div class="buttons">
        <button class="btn-load" id="loadButton">ğŸ“‚ NaÄÃ­st Excel</button>
        <button class="btn-save" id="saveButton">ğŸ’¾ UloÅ¾it do Excel</button>
        <button class="btn-new" id="importButton">ğŸ“¥ Importovat CSV</button>
      </div>
    </div>
    
    <div class="card" id="statsCard" style="display: none;">
      <h2>ğŸ“Š Statistiky</h2>
      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">CelkovÃ¡ spotÅ™eba</div>
          <div class="stat-value" id="totalConsumption">0 mÂ³</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">PrÅ¯mÄ›rnÃ¡ spotÅ™eba</div>
          <div class="stat-value" id="avgConsumption">0 mÂ³</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">CelkovÃ¡ cena</div>
          <div class="stat-value" id="totalPrice">0 KÄ</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">PoÄet odeÄtÅ¯</div>
          <div class="stat-value" id="recordCount">0</div>
        </div>
      </div>
    </div>
    
    <div class="card" id="chartCard" style="display: none;">
      <h2>ğŸ“ˆ Graf spotÅ™eby</h2>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>
    
    <div class="card" id="historyCard" style="display: none;">
      <h2>ğŸ“‹ Historie odeÄtÅ¯</h2>
      <div class="table-container">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Ref. stav</th>
              <th>NovÃ½ stav</th>
              <th>SpotÅ™eba (mÂ³)</th>
              <th>Cena (KÄ)</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let currentData = [];
    let chart = null;

    // NastavenÃ­ dneÅ¡nÃ­ho data
    document.getElementById("datum").value = new Date().toISOString().split('T')[0];

    function calculate() {
      const reference = parseFloat(document.getElementById("reference").value) || 0;
      const stav = parseFloat(document.getElementById("stav").value) || 0;
      const vodne = parseFloat(document.getElementById("vodne").value) || 0;
      const stocne = parseFloat(document.getElementById("stocne").value) || 0;
      const dph = parseFloat(document.getElementById("dph").value) || 0;

      const spotreba = stav - reference;
      const cena = spotreba * (vodne + stocne) * (1 + dph / 100);

      document.getElementById("spotreba").innerText = spotreba > 0 ? spotreba.toFixed(2) : 0;
      document.getElementById("cena").innerText = spotreba > 0 ? cena.toFixed(2) : 0;
    }

    function showAlert(message, type = 'info') {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert ${type}`;
      alert.style.display = 'block';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 3000);
    }

    function updateStats() {
      if (currentData.length === 0) return;

      const records = currentData.filter(row => row.spotreba > 0);
      const totalConsumption = records.reduce((sum, row) => sum + parseFloat(row.spotreba), 0);
      const avgConsumption = totalConsumption / records.length;
      const totalPrice = records.reduce((sum, row) => sum + parseFloat(row.cena), 0);

      document.getElementById('totalConsumption').textContent = totalConsumption.toFixed(2) + ' mÂ³';
      document.getElementById('avgConsumption').textContent = avgConsumption.toFixed(2) + ' mÂ³';
      document.getElementById('totalPrice').textContent = totalPrice.toFixed(2) + ' KÄ';
      document.getElementById('recordCount').textContent = records.length;

      document.getElementById('statsCard').style.display = 'block';
    }

    function updateChart() {
      if (currentData.length === 0) return;

      const records = currentData.filter(row => row.spotreba > 0);
      const labels = records.map(row => {
        const date = new Date(row.datum);
        return date.toLocaleDateString('cs-CZ', { month: 'short', year: 'numeric' });
      });
      const data = records.map(row => parseFloat(row.spotreba));

      const ctx = document.getElementById('consumptionChart').getContext('2d');
      
      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'SpotÅ™eba (mÂ³)',
            data: data,
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value + ' mÂ³';
                }
              }
            }
          }
        }
      });

      document.getElementById('chartCard').style.display = 'block';
    }

    function updateHistoryTable() {
      if (currentData.length === 0) return;

      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';

      currentData.slice().reverse().forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(row.datum).toLocaleDateString('cs-CZ')}</td>
          <td>${row.reference}</td>
          <td>${row.stav}</td>
          <td>${parseFloat(row.spotreba).toFixed(2)}</td>
          <td>${parseFloat(row.cena).toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('historyCard').style.display = 'block';
    }

    document.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", calculate);
    });

    document.getElementById("loadButton").addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".xlsx,.xls";

      input.addEventListener("change", (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: ['datum', 'reference', 'stav', 'spotreba', 'cena'] });

            currentData = jsonData.slice(1); // Skip header row

            if (currentData.length > 0) {
              const lastRecord = currentData[currentData.length - 1];
              document.getElementById("reference").value = lastRecord.stav;
              document.getElementById("datum").value = new Date().toISOString().split('T')[0];
              
              showAlert('âœ… Excel soubor ÃºspÄ›Å¡nÄ› naÄten!', 'success');
              updateStats();
              updateChart();
              updateHistoryTable();
              calculate();
            }
          } catch (error) {
            showAlert('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ souboru: ' + error.message, 'info');
          }
        };

        reader.readAsArrayBuffer(file);
      });

      input.click();
    });

    document.getElementById("saveButton").addEventListener("click", () => {
      const reference = document.getElementById("reference").value;
      const stav = document.getElementById("stav").value;
      const datum = document.getElementById("datum").value;
      const spotreba = document.getElementById("spotreba").innerText;
      const cena = document.getElementById("cena").innerText;

      if (!stav || !datum) {
        showAlert('âš ï¸ VyplÅˆte prosÃ­m stav vodomÄ›ru a datum!', 'info');
        return;
      }

      const newRecord = {
        datum: datum,
        reference: reference,
        stav: stav,
        spotreba: spotreba,
        cena: cena
      };

      currentData.push(newRecord);

      const ws_data = [
        ['Datum', 'ReferenÄnÃ­ stav', 'NovÃ½ stav', 'SpotÅ™eba (mÂ³)', 'Cena (KÄ)'],
        ...currentData.map(row => [row.datum, row.reference, row.stav, row.spotreba, row.cena])
      ];

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "OdeÄty");

      XLSX.writeFile(wb, "odecet_vody.xlsx");

      showAlert('âœ… ZÃ¡znam uloÅ¾en do Excel souboru!', 'success');
      updateStats();
      updateChart();
      updateHistoryTable();
    });

    document.getElementById("newButton").addEventListener("click", () => {
      if (confirm('Opravdu chcete vytvoÅ™it novÃ½ soubor? AktuÃ¡lnÃ­ data budou smazÃ¡na.')) {
        currentData = [];
        document.getElementById("reference").value = '';
        document.getElementById("stav").value = '';
        document.getElementById("spotreba").innerText = '0';
        document.getElementById("cena").innerText = '0';
        
        document.getElementById('statsCard').style.display = 'none';
        document.getElementById('chartCard').style.display = 'none';
        document.getElementById('historyCard').style.display = 'none';
        
        showAlert('ğŸ“„ NovÃ½ soubor vytvoÅ™en. MÅ¯Å¾ete zaÄÃ­t zadÃ¡vat data.', 'success');
      }
    });

    calculate();
  </script>
</body>
</html>